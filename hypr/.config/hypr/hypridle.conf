# ~/.config/hypr/hypridle.conf
general {
    lock_cmd = pidof hyprlock || hyprlock       # auto-restart hyprlock if killed
    before_sleep_cmd = hyprlock                 # lock before suspend
    after_sleep_cmd = hyprctl dispatch dpms on  # turn on display after resume
}

# 1. Save brightness (once) – 1s before dim
listener {
    timeout = 239
    on-timeout = sh -c '[ ! -f /tmp/hypr_brightness_save ] && brightnessctl get > /tmp/hypr_brightness_save'
}

# 2. Dim screen to 20% (4 min)
listener {
    timeout = 240
    on-timeout = brightnessctl set 20%
}

# 3. Keyboard backlight off (1 min) – skip if media playing
listener {
    timeout = 60
    on-timeout = sh -c '
        if ! playerctl status 2>/dev/null | grep -q Playing; then
            [ ! -f /tmp/hypr_kbd_save ] && \
                brightnessctl -d rgb:kbd_backlight get > /tmp/hypr_kbd_save 2>/dev/null || true
            brightnessctl -d rgb:kbd_backlight set 0
        fi
    '
}

# 4. Warning notification (30s before lock)
listener {
    timeout = 270
    on-timeout = notify-send "Locking in 30 seconds…" \
        "Move mouse or press a key to cancel" \
        -a hypridle -u low -i system-lock-screen -t 5000
}

# 5. LOCK + RANDOM WALLPAPER (5 min)
listener {
    timeout = 300
    on-timeout = ~/.config/hypr/scripts/random-lock-wallpaper.sh && hyprlock
}

# 6. Turn off display (6 min)
listener {
    timeout = 360
    on-timeout = hyprctl dispatch dpms off
    on-resume  = hyprctl dispatch dpms on
}

# 7. Suspend (10 min) – lock first, then suspend
listener {
    timeout = 600
    on-timeout = hyprlock && systemctl suspend
}

# 8. GLOBAL RESUME – restore everything on any wake-up
listener {
    timeout = 0
    on-resume = sh -c '
        hyprctl dispatch dpms on
        [ -f /tmp/hypr_brightness_save ] && {
            brightnessctl set "$(cat /tmp/hypr_brightness_save)%"
            rm -f /tmp/hypr_brightness_save
        }
        [ -f /tmp/hypr_kbd_save ] && {
            brightnessctl -d rgb:kbd_backlight set "$(cat /tmp/hypr_kbd_save)" 2>/dev/null || true
            rm -f /tmp/hypr_kbd_save
        }
    '
}
