# ~/.config/hypr/hypridle.conf
# Fully working version – November 2025
# Copy-paste this exactly. No extra spaces, no smart quotes.

general {
    # ignore_idle_inhibit was removed in recent versions
    # If you still want it, use per-listener ignore_inhibit = true
}

# 1. Save brightness once – 1s before dim
listener {
    timeout = 239
    on-timeout = sh -c '[ ! -f /tmp/hypr_brightness_save ] && brightnessctl get > /tmp/hypr_brightness_save'
}

# 2. Dim screen (4 min)
listener {
    timeout = 240
    on-timeout = brightnessctl set 20%
}

# 3. Keyboard backlight off (skip if media playing)
listener {
    timeout = 60
    on-timeout = sh -c '
        if ! playerctl status 2>/dev/null | grep -q Playing; then
            [ ! -f /tmp/hypr_kbd_save ] && \
                brightnessctl -d rgb:kbd_backlight get > /tmp/hypr_kbd_save 2>/dev/null || true
            brightnessctl -d rgb:kbd_backlight set 0
        fi
    '
}

# 4. Warning – 30s before lock
listener {
    timeout = 270
    on-timeout = notify-send "Locking in 30 seconds" "Move your mouse or press a key to cancel." --app-name=hypridle --urgency=low --icon=system-lock-screen --expire-time=5000
}

# 5. Lock screen (5 min) + random wallpaper
listener {
    timeout = 300
    on-timeout = ~/.config/hypr/scripts/random-lock-wallpaper.sh && hyprlock
}

# 6. DPMS off (6 min)
listener {
    timeout = 360
    on-timeout = hyprctl dispatch dpms off
    on-resume = hyprctl dispatch dpms on
}

# 7. Suspend (10 min) – with fallback saves
listener {
    timeout = 600
    on-timeout = sh -c '
        [ ! -f /tmp/hypr_brightness_save ] && brightnessctl get > /tmp/hypr_brightness_save
        [ ! -f /tmp/hypr_kbd_save ] && \
            brightnessctl -d rgb:kbd_backlight get > /tmp/hypr_kbd_save 2>/dev/null || true
        hyprlock && systemctl suspend
    '
}

# 8. GLOBAL RESUME – restore brightness + keyboard + DPMS on ANY wake
listener {
    timeout = 0
    on-resume = sh -c '
        hyprctl dispatch dpms on

        if [ -f /tmp/hypr_brightness_save ]; then
            saved=$(cat /tmp/hypr_brightness_save)
            brightnessctl set "${saved}%"
            rm -f /tmp/hypr_brightness_save
        fi

        if [ -f /tmp/hypr_kbd_save ]; then
            saved=$(cat /tmp/hypr_kbd_save)
            brightnessctl -d rgb:kbd_backlight set "$saved" 2>/dev/null || true
            rm -f /tmp/hypr_kbd_save
        fi
    '
}
